# 1. 단위 테스트의 목표

- 1장에서 다루는 내용

  - 단위 테스트의 상태
  - 단위 테스트의 목표
  - 좋지 않은 테스트 스위트 결과
  - 테스트 스위트 커버리지 지표
  - 성공적인 테스트 스위트의 속성

- 단위 테스트를 배우는 것
  - 테스트 프레임워크나 목 라이브러리 등과 같은 기술 적인 부분을 익히는 것에 그치지 않는다
- 단위 테스트는 단순히 테스트를 작성하는 것보다 더 큰 범주다
- 단위 테스트에 시간을 투자할 때는 항상 최대한 이득을 얻도록 노력해야 하며, 테스트에 드는 노력을 가능한 한 줄이고
  - 그에 따른 이득을 최대화해야 한다
  - 이 두가지를 모두 달성 -> 균형을 달성한 프로젝트
- 이러한 균형을 프로젝트 : 끊임 없이 변화하는 고객의 요구에 신속히 대응할 수 있는 프로젝트
- 그렇지 않은 경우
  - 단위 테스트를 매우 많이 작성하더라도 많은 버그와 유지비로 프로젝트 진행이 느려지게 된다
- 이는 다양한 단위 테스트 기술 간의 차이다
  - 일부는 훌륭한 결과를 만들고 소프트웨어 품질을 지키는 데 도움이 된다
  - 그렇지 않은 경우도 있는데, 일반적으로 도움이 되지 않고 자주 고장 나며 유지 보수가 많이 필요하다
- 이 책에서 다루는 내용은 어떤 단위 테스트 기술이 좋은지를 구별하는 데 도움이 될 것이다
  - 테스트에 대한 비용 편익 분석(cost-benefit analysis) 방법을 배우고 특정 상황에서 적절한 테스트 기술을 적용
  - 공통적인 안티 패턴(anti-pattern: 청므에는 괜찮은 것 같지만 미래에 문제를 야기하는 패턴)을 피하는 방법도 배운다
- 1장에서는 `테스트 작성`과 `유지보수의 목표를 설명`하며 `테스트 스위트를 잘 작성할 수 있는 방법`을 소개한다

## 1.1 단위 테스트 현황

- 단위 테스트를 적용할 것을 독려하는 분위기
- 이제 대부분의 회사에서 필수로 간주될 정도로 독려는 성공했다
- 단위 테스트를 적용해야 하는지는 더 이상 논쟁거리가 아니다
  - 그냥 쓰고 버리는 프로젝트가 아니면, 단위 테스트는 늘 적용해야 한다
- 제품 코드와 테스트 코드의 비율은 1:3 정도로 테스트 코드 비율이 높다
- 좋은 단위 테스트를 작성하는 것은 어떤 의미인가?
- 어떤 것이 단위 테스트를 좋게 만드는지에 대한 논쟁은 매우 중요하다
- 이 책은 이상적인 단위 테스트에 대해 정확하고 과학적인 정의를 다룬다
  - 실제 사례에서 어떻게 적용되는지 살펴본다
  - 특정 프로젝트에서 테스트를 많이 수행했는데도 왜 어긋나는지를 이해하고, 그 과정을 바로잡는 법을 이해할 수 있길 바란다
- 기업용 애플리케이션
  - 높은 비즈니스 복잡도
  - 긴 프로젝트 수명
  - 중간 크기의 데이터
  - 낮은 수준이나 중간 수준 정도의 성능 요구

## 1.2 단위 테스트의 목표

- 단위 테스트를 하기 위해 도움이 되는 목표를 생각해보자

  - 단위 테스트 활동이 더 나은 설계로 이어진다
  - 코드베이스에 단위 테스트 작성이 필요하면 일반적으로 더 나은 설계로 이어진다
  - 하지만 단위 테스트의 주 목표는 아니다. 더 나은 설계는 단지 좋은 사이드 이펙트일 뿐이다

- 단위 테스트와 코드 설계의 관계

  - 코드를 단위 테스트하기 어렵다면 코드 개선이 반드시 필요하다는 것을 의미한다
  - 보통 강결합(tight coupling)에서 저품질이 나타나는데, 여기서 강결합은 제품 코드가 서로 충분히 분리되지 않아서 따로 테스트하기 어려움을 뜻한다
  - 그렇지만 코드베이스를 쉽게 테스트할 수 있다고 해도 반드시 좋은 것을 의미하지는 않는다

- 단위 테스트의 목표는 무엇인가?
  - 소프트웨어 프로젝트의 `지속 가능`한 성장을 가능하게 하는 것
  - 테스트가 없다면 진척도가 높아질 수록 작업 소요시간은 훨씬 더 길어진다
- 엔트로피: 시스템 내 무질서도
- 지속적인 정리와 리팩터링 등과 같은 적절한 관리를 하지 않고 방치하면 시스템이 점점 더 복잡해지고 무질서해진다
  - 테스트로 이런 경향을 뒤집을 수 있다(안전망 역할)
- 코드베이스를 짓혹적으로 검증하는 테스트 없이는 소프트웨어 개발이 쉽게 확장되지 않는다
  - 지속성과 확장성이 핵심이며, 이를 통해 장기적으로 개발 속도를 유지할 수 있다

### 1.2.1 좋은 테스트와 좋지 않은 테스트를 가르는 요인

- 모든 테스트를 작성할 필요는 없다
  - 일부 테스트는 아주 중요하고 소프트웨어 품질에 매우 많은 기여를 한다
  - 그 밖에 다른 테스트는 그렇지 않다
    - 잘못된 경고가 발생하고, 회귀 오류를 알아내는 데 도움이 되지 않으며, 유지보수가 어렵고 느리다
    - 프로젝트에 도움이 되는지 여부를 명확하게 파악하지 않고 단위 테스트를 작성하는 데 빠져들기 쉽다
- 단지 프로젝트에서 테스트를 더 많이 쏟아내도 단위 테스트의 목표를 달성할 수 없다

  - 테스트의 가치와 유지비용을 모두 고려해야 한다

- **테스트의 가치와 유지비용을 고려하는 방법**

  - 기반 코드를 리팩터링할 때 테스트도 리팩터링하라
  - 각 코드 변경 시 테스트를 실행하라
  - 테스트가 잘못된 경고를 발생시킬 경우 처리하라
  - 기반 코드가 어떻게 동작하는지 이해하려고 할 때는 테스트를 읽는 데 시간을 투자하라

- 높은 유지보수 비용으로 순가치가 0에 가깝거나 심지어 0보다 작은 테스트를 만들기 쉽다

  - 지속가능한 프로젝트 성장을 위해서는 고품질 테스트에만 집중해야 한다
  - 고품질 테스트만이 테스트 스위트에 남을 만한 테스트 유형이다

- 제품 코드 vs. 테스트 코드

  - 코드는 자산이 아니라 책임이다
    - 코드가 더 많아질 수록 소프트웨어 내의 잠재적인 버그에 노출되는 표면적이 더 넓어지고 프로젝트 유지비가 증가한다
    - 따라서 가능한 적은 콬드로 문제를 해결하는 것이 좋다
  - 테스트도 역시 코드다
    - 특정 문제를 해결하는 것, 즉 애플리케이션의 정확성을 보장하는 것을 목표로 하는 코드베이스의 일부로 봐야 한다
    - 다른 코드와 마찬가지로 단위 테스트도 버그에 취약하고 유지보수가 필요하다

- 좋은 테스트와 나쁜 테스트 구별하는 방법 -> 4장

## 1.3 테스트 스위트 품질 측정을 위한 커버리지 지표

- 가장 널리 사용되는 두 가지 커버리지 지표
  - `코드 커버리지`
  - `분기 커버리지`
- 특정 커버리지 숫자를 목표로 하는 것이 해로운 이유와 테스트 스위트 품질을 결정하는 데 커버리지 지표에 의존할 수 없는 이유를 알아본다
- 커버리지 지표는 괜찮은 부정 지표이지만 좋지 않은 긍정 지표다
  - 코드 커버리지가 너무 적을 때(예를 들면, 10%)는 테스트가 충분치 않다는 좋은 증거이다
  - 그러나 반대의 경우는 그렇지 못하다
    - 100% 커버리지라고 해서 반드시 양질의 테스트 스위트라고 보장하지는 않는다
    - 높은 커버리지의 테스트 스위트도 품질이 떨어질 수 있다

### 1.3.1 코드 커버리지 지표에 대한 이해

- 가장 많이 사용되는 코드 커버리지(또는 테스트 커버리지)

  - 코드 커버리지(테스트 커버리지) = 제품 코드 라인 수 / 전체 라인 수

- 예. if문에서 한가지 조건만 검사
  - 커버리지: 80%
  - 테스트코드는 그대로인데 if문을 삼항연산자로 변경 -> 커버리지: 100%

### 1.3.2 분기 커버리지 지표에 대한 이해

- 분기 커버리지는 코드 커버리지의 단점을 극복하는 데 도움이 되므로 코드 커버리지보다 더 정확한 결과를 제공한다
- 분기 커버리지 = 테스트가 통과한 분기 수 / 전체 분기 수

### 1.3.3 커버리지 지표에 관한 문제점

- 분기 커버리지로 코드 커버리지보다 더 나은 결과를 얻을 수 있지만,
  테스트 스위트의 품질을 결정 하는 데 어떤 커버리지 지표도 의존할 수 없는 이유는 다음과 같다
  - 테스트 대상 시스템의 모든 가능한 결과를 검증한다고 보장할 수 없다
  - 외부 라이브러리의 코드 경로를 고려할 수 있는 커버리지 지표는 없다

#### 가능한 모든 결과를 검증한다고 보증할 수 없음

- 실제로 테스트하려면, 단위 테스트에는 반드시 적절한 검증이 있어야 한다
  - 테스트 대상 시스템이 낸 결과가 정확히 예상되는 결과인지 확인해야 한다
  - 결과가 여러개 있을 수 있기 때문에 커버리지 지표가 의미가 있으려면, 모든 측정 지표를 검증해야 한다

#### 외부 라이브러리의 코드 경로를 고려할 수 없음

- 테스트에서 라이브러리의 모든 예외 상황을 다루는지 확인할 방법이 없다

### 1.3.4 특정 커버리지 숫자를 목표로 하기

- 예를 들면, 70% 커버리지 숫자를 목표로 삼기 시작하면 위험 영역으로 이어질 수 있다
- 커버리지 지표를 보는 가장 좋은 방법은 지표 그 자체로 보는 것이며, 목표로 여겨서는 안 된다
- 이 경우, 중요한 것을 테스트하는 것이 아닌 인공적인 목표를 달성하기 위한 방법을 찾기 시작한다
- **팁**

  - 시스템의 핵심 부분은 커버리지를 높게 두는 것이 좋다
  - 하지만 이 높은 수준을 요구 사항으로 삼는 것은 좋지 않다(매우 중요!)

- 커버리지 숫자가 낮으면(예: 60% 미만) 문제 징후라 할 수 있다
  - 코드베이스에 테스트 되지 않은 코드가 많다는 뜻이다
  - 그러나 높은 숫자도 별 의미는 없다
  - 그러므로 코드 커버리지를 측정하는 것은 품질 테스트 스위트로 가는 첫걸음일 뿐이다

## 1.4 무엇이 성공적인 테스트 스위트를 만드는가?

- 위에서 부적절한 테스트 스위트 품질 측정법을 주로 다뤘다.
  - 제대로 하려면 어떻게 해야할까?
  - 테스트 스위트의 품질을 어떻게 측정해야 하는가?
- 믿을 만한 방법은 스위트 내 각 테스트를 하나씩 따로 평가하는 것뿐이다
- 테스트 스위트가 얼마나 좋은지 자동으로 확인할 수 없다. 개인의 판단에 맡겨야 한다
- 성공적인 테스트 스위트의 특성
  - 개발 주기에 통합돼 있다
  - 코드베이스에 가장 중요한 부분만을 대상으로 한다
  - 최소한의 유지비로 최대의 가치를 끌어낸다

### 1.4.1 개발 주기에 통합돼 있음

- 모든 테스트는 개발 주기에 통합돼야 한다
- 이상적으로는 코드가 변경될 때마다 아무리 작은 것이라도 실행해야 한다

### 1.4.2 코드베이스에서 가장 중요한 부분만을 대상으로 함

- 테스트가 주는 가치는 테스트 구조뿐만 아니라 검증하는 코드에도 있다
- 시스템의 가장 중요한 부분에 단위 테스트 노력을 기울이고, 다른 부분은 간략하게 또는 간접적으로 검증하는 것이 좋다
- 대부분의 애플리케이션에서 가장 중요한 부분은 비즈니스 로직(도메인 모델)이 있는 부분이다
- 비즈니스 로직 테스트가 시간 투자 대비 최고의 수익을 낼 수 있다
- 다른 모든 부분은 세 가지 범주로 나눌 수 있다
  - 인프라 코드
  - 데이터베이스나 서드파티 시스템과 같은 외부 서비스 및 종속성
  - 모든 것을 하나로 묶는 코드
- 그러나 위 세가지 중 일부는 테스트를 철저히 해야할 수 있다
  - 예를 들어, 인프라코드에 복잡하고 중요한 알고리즘이 있을 수 있다
  - 그러나 일반적으로 도메인 모델에 관심을 더 많이 갖는 것이 옳다
- 통합테스트와 같이 일부 테스트는 도메인 모델을 넘어 코드베이스의 중요하지 않은 부분을 포함하기 때문에
  시스템이 전체적으로 어떻게 작동하는지 확인할 수 있다
  - 이것도 괜찮다. 그러나 초점은 도메인 모델에 머물러 있어야 한다
- 이 지침을 따르려면 도메인 모델을 코드베이스 중 중요하지 않은 부분과 분리해야 한다
  - 2부에서 자세히 다룬다

### 1.4.3 최소 유지비로 최대 가치를 끌어냄

- 단위 테스트에서 가장 어려운 부분은 최소 유지비로 최대 가치를 달성하는 것이다(이 책의 핵심)
- 테스트를 빌드 시스템에 통합하는 것으로도, 도메인 모델에 높은 테스트 커버리지를 유지하는 것으로도 충분하지 않다
  - 가치가 유지비를 상회하는 테스트만 스위트에 유지하는 것이 중요하다
- 유지비 상회를 위한 속성
  - 가치 있는테스트(더 나아가, 가치가 낮은 테스트) 식별하기
  - 가치 있는 테스트 작성하기
- 위 두 개는 비슷해 보이지만 다르다
  - 가치가 높은 테스트를 식별
    - 기준 틀(frame of reference)이 필요하다
  - 가치 있는 테스트를 작성하려면 코드 설계 기술도 알아야 한다
- 따라서 이 책의 상당 부분은 코드 설계에 할애하고 있다

## 1.5 이 책을 통해 배우는 것

- 테스트 스위트 내의 모든 테스트를 분석하는 데 사용할 수 있는 기준틀을 설명한다
- 새로운 관점에서 테스트를 볼 수 있다
  - 어떤 것이 프로젝트에 기여하고 어떤 것을 리팩터링해야 하거나 완전히 제거해야 하는지 알 수 있을 것이다
- 기초를 다지기 => 4장
- 기존 단위 테스트 기술과 실천을 살펴본다 => 4 ~ 6장, 7장 일부

## 요약

- 코드는 점점 나빠지는 경향이 있다
  - 테스트로 이러한 경향을 뒤집을 수 있다(안전망 역할)
- 단위 테스트를 작성하는 것이 중요하다
- 단위 테스트의 목표는 소프트웨어 프로젝트가 지속적으로 성장하게 하는 것이다
- 모든 테스트를 똑같이 작성할 필요는 없다
  - 각각의 테스트는 비용과 편익 요소가 있으며, 둘 다 신중하게 따져볼 필요가 있다
  - 테스트 스위트 내에 가치 있는 테스트만 남기고 나머지는 모두 제거하라
  - 애플리케이션과 테스트 코드는 모두 자산이 아니라 부채다
- 커버리지가 높다고 해서 품질이 높은 것은 아니다
  - 테스트 스위트의 품질이 중요하다
- 성공적인 테스트 스위트는 다음과 같은 특성을 나타낸다
  - 개발 주기에 통합돼 있다
  - 코드베이스 중 가장 중요한 부분만을 대상으로 한다
  - 최소한의 유지비로 최대의 가치를 끌어낸다
- 단위 테스트의 목표를 달성하기 위한 유일한 방법은 다음과 같다
  - 좋은 테스트와 좋지 않은 테스트를 구별하는 방법을 배운다
  - 테스트를 리팩터링해서 더 가치있게 만든다
