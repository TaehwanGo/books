# 2. 데이터 모델과 SQL

## 1. 정규화(Normalization)

- 데이터 정합성(데이터의 정확성과 일관성을 유지하고 보장)을 위해 엔터티를 작은 단위로 분리하는 과정
- 정규화를 할 경우 데이터 조회성능은 처리조건에 따라 향상되는 경우도 있고 저하되는 경우도 있지만
  - 입력, 수정, 삭제 성능은 일반적으로 향상된다고 볼 수 있다
- 하지만 그렇다고 모든 엔터티를 무작정 분리하면 안 되기 때문에 정규화를 하기 위한 일정한 룰이 존재한다

### (1) 제 1 정규형

- 모든 속성은 반드시 하나의 값만 가져야 한다
- 회원

  - 이름
  - 생년월일
  - 직업
    - 배우, 가수, 작곡가 -> 이런 식으로 여러 개의 값을 가질 수 없다

- 속성값이 하나가 되도록 엔터티를 분리한다
- 유사한 속성이 반복되지 않도록 엔터티를 분리한다

#### Level up test1: 정규화

- 정규화를 하면 엔터티가 계속 증가하므로 JOIN으로 인한 조회 성능 저하가 발생할 수 있다
- 데이터 입력, 수정, 삭제 성능이 향상된다
- 정규화를 할수록 엔터티는 증가한다
- 데이터에 대한 중복성을 제거한다

### (2) 제 2 정규형

- 엔터티의 모든 일반속성은 반드시 모든 주식별자에 종속되어야 한다

#### Level up test

- 회원
  - 회원번호(PK)
  - 아이디
  - 이름
  - 가족1
  - 가족2
  - 가족3
- 회원 엔티티는 가족1, 가족2, 가족3 속성과 같이 유사한 속성의 반복 그룹 형태를 갖고 있으며 이는 1차 정규화 대상이 된다

### (3) 제 3 정규형

- 주 식별자가 아닌 모든 속성 간에는 종속될 수 없다

| 일련번호 | 이름   | 생년월일   | 소속사코드 | 소속사명 |
| -------- | ------ | ---------- | ---------- | -------- |
| 1        | 홍길동 | 1990-01-01 | 1          | SM       |
| 2        | 김철수 | 1991-01-01 | 2          | JYP      |

- 일반속성인 소속사명이 다른 일반속성인 소속사코드에 종속

| 일련번호 | 이름   | 생년월일   | 소속사코드 |
| -------- | ------ | ---------- | ---------- |
| 1        | 홍길동 | 1990-01-01 | 1          |
| 2        | 김철수 | 1991-01-01 | 2          |

| 소속사코드 | 소속사명 |
| ---------- | -------- |
| 1          | SM       |
| 2          | JYP      |

#### Level up test

- 제 3 정규형 위반인 것은?
  - 이벤트번호, 응모회원번호,
  - 회원번호, 아이디, 회원등급코드, 회원등급명

### (4) 주의사항

- 적절한 정규화는 성능상 이롭지만 지나친 정규화는 오히려 성능 저하를 일으킬 수 있다

## 2. 반정규화

- 데이터의 조회 성능을 향상시키기 위해 데이터의 중복을 허용하거나 데이터를 그룹핑하는 과정이다
- 주의점 : 조회 성능은 향상될 수 있으나 입력, 수정, 삭제 성능은 저하될 수 있으며 데이터 정합성 이슈가 발생할 수 있다
- 반정규화의 과정은 정규화가 끝난 후 거치게 되며 정규화와 마찬가지로 일정한 룰이 존재한다

### (1) 테이블 반정규화

- 테이블 병합

  - 1:1 관계 테이블 병합
  - 1:M 관계 테이블 병합
  - 슈퍼 서브 타입 테이블 병합

- 테이블 분할

  - 수직 분할(속성 분할)
  - 수평 분할(인스턴스 분할, 파티셔닝)

- 테이블 추가
  - 중복 테이블 추가
  - 통계 테이블 추가
  - 이력 테이블 추가
  - 부분 테이블 추가

#### 테이블 병합

- JOIN이 필요한 경우가 많아 테이블을 통합하는 것이 성능 측면에서 유리할 경우고려한다
- `1:M 관계` 테이블 병합의 경우 1쪽에 해당하는 엔터티의 속성 개수가 많으면 병합했을 경우 `중복 데이터가 많아`지므로 테이블 병합에 적절하지 못하다

#### 테이블 분할

- 테이블 수직 분할 : 엔터티의 일부 속성을 별도의 엔터티로 분할(1:1 관계 성립)
- 테이블 수평 분할 : 엔터티의 인스턴스를 특정 기준으로 별도의 엔터티로 분할(파티셔닝)

#### 테이블 추가

- 중복 테이블 추가 : 데이터의 중복을 감안하더라도 성능상 반드시 필요하다고 판단되는 경우 별도의 엔터티를 추가한다
- 통계 테이블 추가
- 이력 테이블 추가
- 부분 테이블 추가

### (2) 컬럼 반정규화

- 중복 컬럼 추가
  - 업무 프로세스상 JOIN이 필요한 경우가 많아 컬럼을 추가하는 것이 성능 측면에서 유리할 경우 고려한다
- 파생 컬럼 추가
  - 프로세스 수행 시 부하가 염려되는 계산값을 미리 컬럼으로 추가하여 보관하는 방식
  - e.g. 상품의 재고, 프로모션 적용 할인가 등
- 이력 테이블 컬럼 추가
  - 대량의 이력 테이블을 조회할 때 속도가 느려질 것을 대비하여 조회 기준이 될 것으로 판단되는 컬럼을 미리 추가해 놓는 방식이다
  - 최신 데이터 여부 등이 이에 해당할 수 있다

### (3) 관계 반정규화(중복관계 추가)

- 업무 프로세스상 JOIN이 필요한 경우가 많아 중복 관계를 추가하는 것이 성능 측면에서 유리할 경우

## 3. 트랜잭션(Transaction)

- 데이터를 조작하기 위한 하나의 논리적인 작업 단위
- e.g. 온라인에서 퀴즈 정답을 맞히면 쿠폰을 발행해주는 이벤트, 쿠폰은 선착순 100명에게만 지급된다
  - 아래 작업이 하나의 단위로 묶여야 한다
    - 이벤트 응모 이력을 저장한다
    - 쿠폰을 발행한다

## NULL

### (1) NULL 이란?

- 존재하지 않음, 값이 없음을 의미한다
- NULL은 숫자 0, 문자열 ''과는 다른 개념이다

#### SQL에서 NULL이 포함된 경우의 계산

| BIRTHDAY | NAME   | INCOME | EXPENSE | JOB  |
| -------- | ------ | ------ | ------- | ---- |
| 1990-01  | 홍길동 | 100    | 50      | 배우 |
| 1991-01  | 김철수 | NULL   | 100     | 가수 |

- `SELECT * FROM ACCOUNT;`
- `SELECT NAME, INCOME - EXPENSE FROM ACCOUNT;`
  - NULL - 50 = NULL
  - 가로연산에서 NULL이 포함되어 있으면 결과값은 NULL
- `SELECT SUM(INCOME) FROM ACCOUNT;`
  - 세로연산에서 다른 인스턴스의 데이터와 연산할 때는 NULL값을 제외한다

## Chapter2. 적중 예상 문제

### 1. 성능 데이터 모델링

- 성능 데이터 모델링 : 데이터 베이스의 성능을 향상시키기 위해 설계 단계부터 성능과 관련된 사항들이 모델링에 반영될 수 있도록 하는 것

### 3. 정규화

- 하나의 속성이 여러 개의 속성값을 갖는 데이터 모델 -> 1차 정규화 대상
- 테이블 병합 -> 반정규화 기법 중 하나
- 성능 향상을 위해 중복 테이블 추가 -> 반정규화 기법 중 하나

### 4. 정규화

#### 기존

- 회원
  - 회원번호(PK)
  - 아이디
  - 이름
  - 배송지1
  - 배송지2
  - 배송지3

#### 정규화

- 회원
  - 회원번호(PK)
  - 아이디
  - 이름
- 배송지
  - 회원번호(FK, PK)
  - 배송지번호(PK)
  - 배송지

### 5. 테이블 반정규화 기법

- 테이블 병합
  - 1:1 관계 테이블 병합
  - 1:M 관계 테이블 병합
  - 슈퍼/서브 타입 테이블 병합
- 테이블 분할
  - 수직 분할(속성 분할)
  - 수평 분할(인스턴스 분할, 파티셔닝)
- 테이블 추가
  - 중복 테이블 추가
  - 통계 테이블 추가
  - 이력 테이블 추가

### 6. 데이터 모델링의 순서

- 데이터 모델에 맞게 정규화를 수행한다
- 데이터베이스의 용량 및 트랜잭션 유형을 파악하여 성능 저하를 일으키는 부분이 없는지 검토한다
- 용량과 트랜잭션 유형에 맞게 반정규화를 수행한다
- 성능 향상을 위한 이력모델의 조정, PK/FK 조정, 슈퍼/서브타입 조정 등을 수행한다
- 데이터 모델의 성능을 검증한다

### 8. 한 테이블의 속성 개수가 과도하게 많을 때

- 자주 쓰는 컬럼만 분리하여 데이터 성능 조회 성능을 향상시킬 수 있다
- 테이블 수직분할은 정규화가 아니라 반정규화다

### 9. 반정규화 기법

- 반정규화의 테이블 분할

  - 수직 분할: 테이블의 일부 속성을 별도의 테이블로 분리하는 것
  - 수평 분할: 테이블의 특정 인스턴스를 별도의 테이블로 분할하는 것
  - 그 외 나머지 테이블 분할은 정규화다

- 파생 컬럼 추가 : 프로세스 수행 시 부하가 염려되는 계산값을 미리 컬럼으로 추가한다
- 통계테이블 추가 : 성능 향상을 위해 데이터의 통계치를 미리 계산하여 저장한다
- 중복 관계 추가 : 업무 프로세스상 JOIN이 필요한 경우가 많아 중복 관계를 추가하는 것이 성능 측면에서 유리할 경우 수행한다

### 10. 아래 데이터 모델에서 생길 수 있는 이상 현상

- 주문

  - 주문번호(PK)
  - 상품코드(PK)
  - 주문일시
  - 주문수량
  - 회원번호
  - 회원명

- 삽입이상: 주문되지 않은 상품의 정보를 삽입할 수 있다
- 갱신이상: 상품명이 업데이트된 경우 해당 상품에 대한 모든 주문 건을 업데이트 해주지 않으면 데이터의 불일치가 발생할 수 있다
- 삭제이상: 주문 데이터를 삭제할 경우 상품 데이터도 함께 삭제될 수 있다

### 11. 트랜잭션

- 트랜잭션은 데이터를 조작하기 위한 논리적인 작업 단위로, 데이터 모델로 표현할 수 있으며 데이터는 트랜잭션 범위로 묶일 수 있다

### 12. NULL 연산

- `WHERE COL IS NULL` 조건은 WHERE COL = NULL 조건과 같을까?
  - WHERE COL IS NULL 조건은 COL 값이 NULL인 행을 반환하지만
    COL = NULL 조건은 항상 FALSE를 반환한다
    - NULL은 존재하지 않음을 의미하는 값이므로 비교 연산자로 비교할 수 없다

### 15. 정규화

- 주문

  - 주문번호(PK)
  - 상품코드(PK)
  - 주문일시
  - 주문수량
  - 회원번호
  - 회원명

- 회원명(일반속성)이 회원번호(일반속성)에 종속되었으므로 3차 정규화 대상이다

### 16. 3차 정규화

- 이행 함수 종속성을 제거한다

### 18. 가격 이력정보 - 이력 엔터티로 분류하여 저장

- 성능우려
- 개선
  - 성능 저하가 우려될 경우 이력 테이블에 컬럼을 추가한다

### 19. 슈퍼-서브타입

- 이슈: 기술직, 관리직
- 공통 속성과 개별 속성을 분리하여 슈퍼-서브타입으로 분류한다

### 20. 중복 관계 추가

- 중복 관계 추가는 관계의 반정규화 기법 중 하나로
  데이터 무결성을 깨뜨릴 위험성 없이 데이터 처리 성능을 향상시킬 수 있는 기법이다
